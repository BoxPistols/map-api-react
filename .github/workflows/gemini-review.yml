name: Gemini AI Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gemini-review:
    # PR„Ç≥„É°„É≥„Éà„Åß /review „Åæ„Åü„ÅØ /summary „ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/review') || contains(github.event.comment.body, '/summary'))
    runs-on: ubuntu-latest

    steps:
      - name: Check command type
        id: command
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" == *"/review"* ]]; then
            echo "type=review" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == *"/summary"* ]]; then
            echo "type=summary" >> $GITHUB_OUTPUT
          fi

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              title: pr.data.title,
              body: pr.data.body || '',
              head: pr.data.head.sha,
              base: pr.data.base.sha
            };

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          # Get the diff via GitHub API
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" > pr_diff.txt

          # Truncate if too large (Gemini has token limits)
          if [ $(wc -c < pr_diff.txt) -gt 30000 ]; then
            head -c 30000 pr_diff.txt > pr_diff_truncated.txt
            echo "...[diff truncated due to size]" >> pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          fi

      - name: Get changed files list
        id: files
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}/files" | \
            jq -r '.[].filename' > changed_files.txt

      - name: Call Gemini API for Review
        if: steps.command.outputs.type == 'review'
        id: gemini-review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PR_TITLE=$(echo '${{ fromJson(steps.pr.outputs.result).title }}' | jq -Rs .)
          PR_BODY=$(echo '${{ fromJson(steps.pr.outputs.result).body }}' | jq -Rs .)
          DIFF_CONTENT=$(cat pr_diff.txt | jq -Rs .)
          FILES_LIST=$(cat changed_files.txt | jq -Rs .)

          # Create prompt for code review
          PROMPT=$(cat <<'PROMPT_END'
          „ÅÇ„Å™„Åü„ÅØÁµåÈ®ìË±äÂØå„Å™„Ç∑„Éã„Ç¢„ÇΩ„Éï„Éà„Ç¶„Çß„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆPull Request„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## „É¨„Éì„É•„ÉºË¶≥ÁÇπ
          1. **„Ç≥„Éº„ÉâÂìÅË≥™**: ÂèØË™≠ÊÄß„ÄÅ‰øùÂÆàÊÄß„ÄÅDRYÂéüÂâá
          2. **„Éê„Ç∞„ÉªÂïèÈ°åÁÇπ**: ÊΩúÂú®ÁöÑ„Å™„Éê„Ç∞„ÄÅ„Ç®„ÉÉ„Ç∏„Ç±„Éº„Çπ„ÄÅ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
          3. **„Çª„Ç≠„É•„É™„ÉÜ„Ç£**: XSS„ÄÅ„Ç§„É≥„Ç∏„Çß„ÇØ„Ç∑„Éß„É≥„ÄÅË™çË®º„ÉªË™çÂèØ„ÅÆÂïèÈ°å
          4. **„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ**: ÈùûÂäπÁéá„Å™„Ç≥„Éº„Éâ„ÄÅN+1ÂïèÈ°å„ÄÅ„É°„É¢„É™„É™„Éº„ÇØ
          5. **„Éô„Çπ„Éà„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ**: React/TypeScript„ÅÆ„Éô„Çπ„Éà„Éó„É©„ÇØ„ÉÜ„Ç£„ÇπÊ∫ñÊã†

          ## Âá∫ÂäõÂΩ¢Âºè
          ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß„É¨„Éì„É•„ÉºÁµêÊûú„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          ### üîç Ê¶ÇË¶Å
          [Â§âÊõ¥„ÅÆÊ¶ÇË¶Å„Çí1-2Êñá„Åß]

          ### ‚úÖ ËâØ„ÅÑÁÇπ
          - [ËâØ„ÅÑÁÇπ„Çí„É™„Çπ„Éà]

          ### ‚ö†Ô∏è ÊîπÂñÑÊèêÊ°à
          - **„Éï„Ç°„Ç§„É´Âêç:Ë°åÁï™Âè∑** - [ÂïèÈ°åÁÇπ„Å®ÊîπÂñÑÊ°à]

          ### üö® ÈáçË¶Å„Å™ÂïèÈ°åÔºà„ÅÇ„Çå„Å∞Ôºâ
          - [ÈáçÂ§ß„Å™„Éê„Ç∞„ÇÑ„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂïèÈ°å]

          ### üìù „Åù„ÅÆ‰ªñ„Ç≥„É°„É≥„Éà
          - [‰ªªÊÑè„ÅÆ„Ç≥„É°„É≥„Éà]
          PROMPT_END
          )

          # Build JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            --argjson title "$PR_TITLE" \
            --argjson body "$PR_BODY" \
            --argjson diff "$DIFF_CONTENT" \
            --argjson files "$FILES_LIST" \
            '{
              contents: [{
                parts: [{
                  text: ($prompt + "\n\n## PR Title\n" + $title + "\n\n## PR Description\n" + $body + "\n\n## Changed Files\n" + $files + "\n\n## Diff\n```diff\n" + $diff + "\n```")
                }]
              }],
              generationConfig: {
                temperature: 0.3,
                maxOutputTokens: 4096
              }
            }')

          # Call Gemini API
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # Extract text from response
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "„É¨„Éì„É•„Éº„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"')

          # Save to file for next step
          echo "$REVIEW_TEXT" > review_result.txt

      - name: Call Gemini API for Summary
        if: steps.command.outputs.type == 'summary'
        id: gemini-summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PR_TITLE=$(echo '${{ fromJson(steps.pr.outputs.result).title }}' | jq -Rs .)
          PR_BODY=$(echo '${{ fromJson(steps.pr.outputs.result).body }}' | jq -Rs .)
          DIFF_CONTENT=$(cat pr_diff.txt | jq -Rs .)
          FILES_LIST=$(cat changed_files.txt | jq -Rs .)

          # Create prompt for summary
          PROMPT=$(cat <<'PROMPT_END'
          „ÅÇ„Å™„Åü„ÅØÁµåÈ®ìË±äÂØå„Å™„ÉÜ„ÇØ„Éã„Ç´„É´„É©„Ç§„Çø„Éº„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆPull Request„ÅÆÂ§âÊõ¥ÂÜÖÂÆπ„ÇíÁ∞°ÊΩî„Å´„Çµ„Éû„É™„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## Âá∫ÂäõÂΩ¢Âºè

          ### üìã Â§âÊõ¥„Çµ„Éû„É™„Éº
          [„Åì„ÅÆPR„Åå‰Ωï„ÇíÈÅîÊàê„Åô„Çã„Åã„ÄÅ1-2Êñá„Åß]

          ### üìÅ Â§âÊõ¥„Éï„Ç°„Ç§„É´Ê¶ÇË¶Å
          | „Éï„Ç°„Ç§„É´ | Â§âÊõ¥ÂÜÖÂÆπ |
          |---------|---------|
          | [„Éï„Ç°„Ç§„É´Âêç] | [Á∞°ÊΩî„Å™Ë™¨Êòé] |

          ### üîß ‰∏ª„Å™Â§âÊõ¥ÁÇπ
          1. [Â§âÊõ¥ÁÇπ1]
          2. [Â§âÊõ¥ÁÇπ2]
          3. [Â§âÊõ¥ÁÇπ3]

          ### üí° ÂΩ±ÈüøÁØÑÂõ≤
          - [„Åì„ÅÆÂ§âÊõ¥„ÅåÂΩ±Èüø„Åô„ÇãÊ©üËÉΩ„ÇÑ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà]

          ### ‚úÖ „ÉÜ„Çπ„ÉàË¶≥ÁÇπ
          - [„Åì„ÅÆÂ§âÊõ¥„Çí„ÉÜ„Çπ„Éà„Åô„ÇãÈöõ„Å´Á¢∫Ë™ç„Åô„Åπ„Åç„Éù„Ç§„É≥„Éà]
          PROMPT_END
          )

          # Build JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            --argjson title "$PR_TITLE" \
            --argjson body "$PR_BODY" \
            --argjson diff "$DIFF_CONTENT" \
            --argjson files "$FILES_LIST" \
            '{
              contents: [{
                parts: [{
                  text: ($prompt + "\n\n## PR Title\n" + $title + "\n\n## PR Description\n" + $body + "\n\n## Changed Files\n" + $files + "\n\n## Diff\n```diff\n" + $diff + "\n```")
                }]
              }],
              generationConfig: {
                temperature: 0.3,
                maxOutputTokens: 2048
              }
            }')

          # Call Gemini API
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # Extract text from response
          SUMMARY_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "„Çµ„Éû„É™„Éº„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"')

          # Save to file for next step
          echo "$SUMMARY_TEXT" > review_result.txt

      - name: Post result to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('review_result.txt', 'utf8');
            const commandType = '${{ steps.command.outputs.type }}';
            const icon = commandType === 'review' ? 'ü§ñ' : 'üìù';
            const title = commandType === 'review' ? 'Gemini Code Review' : 'Gemini PR Summary';

            const body = `## ${icon} ${title}

            ${result}

            ---
            <sub>Powered by Gemini 2.0 Flash | Triggered by \`/${commandType}\` command</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Add success reaction
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Add failure reaction
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });
